<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Statistics</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/home.css" rel="stylesheet">
    <link rel="stylesheet" href="fontawesome-free-6.5.1-web/css/all.min.css">
     <style>
    #chartContainer {
        width: 90%; /* Ajusta al ancho que prefieras */
        margin: 20px auto; /* Aumenta el margen superior para más espacio */
        background-color: #f0f0f0;
        padding: 20px;
        border-radius: 8px;
        overflow: auto;
        display: flex;
        flex-direction: column;
        align-items: center; /* Centrar los elementos horizontalmente */
        gap: 20px; /* Espacio entre los gráficos */
    }

    canvas {
        width: 100%; /* Ocupar todo el ancho del contenedor de gráficos */
        max-width: 800px; /* Máximo ancho del canvas */
        height: auto; /* Altura auto ajustable */
    }

    #myChart {
        width: 60%; 
        height: 200px; /* Altura predefinida para el gráfico doughnut */
        max-width: 300px; /* Tamaño máximo del gráfico para evitar que se estire demasiado en pantallas grandes */
        margin: 0 auto; /* Centrar el gráfico horizontalmente dentro del contenedor */
    }

    #chartContainer h3 {
        color: #333;
        text-align: center; /* Centrar el texto del título */
    }
    </style>
</head>

<body>
    <div id="navbarContainer"></div>
    <header>
        <div class="header-content">
            <div class="header-content-inner" id="chartContainer">
                <canvas id="myChart"></canvas>
            </div>
            <button type="button" class="btn btn-primary btn-lg back" onclick="goBack()">Return</button>
        </div>
    </header>

    <script src="js/jquery-1.11.3.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <!-- Cargar Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <!-- Cargar el plugin de boxplot, asegurándote de que la versión es compatible -->
    <script src="https://cdn.jsdelivr.net/npm/@sgratzl/chartjs-chart-boxplot"></script>
        
    <script>
        $(document).ready(function () {
            $('#navbarContainer').load('navbar.html');
            const urlParams = new URLSearchParams(window.location.search);
            const chatbotId = urlParams.get('chatbotId');
            const questionnaireId = urlParams.get('questionnaireId');

            loadResults(chatbotId, questionnaireId);
        });

        function goBack() {
            window.history.back();
        }

        function loadResults(chatbotId, questionnaireId) {
            $.get(`https://backend-chatbotevaluator.up.railway.app/results?chatbotId=${chatbotId}&questionnaireId=${questionnaireId}`, function (results) {
                console.log(results);
                const susValues = results.filter(result => result.sus !== -1);
                if (susValues.length > 0) {
                    var userId = localStorage.getItem('userId');
                    $.get(`https://backend-chatbotevaluator.up.railway.app/users/${userId}/questionnaires/${questionnaireId}`, function (questionnaire) {
                        console.log(questionnaire);
                        if (questionnaire && questionnaire.questions) {
                            console.log(questionnaire.questions);
                            let transformedQuestions = {};
                            let index = 0;

                            questionnaire.questions.forEach(question => {
                                transformedQuestions[index++] = question.positive;
                                transformedQuestions[index++] = question.negative;
                            });

                            console.log(transformedQuestions);
                            createChart(susValues.map(result => result.sus));
                            generateBoxPlots(susValues, transformedQuestions);
                        }
                    });
                } else {
                    var userId = localStorage.getItem('userId');
                    $.get(`https://backend-chatbotevaluator.up.railway.app/users/${userId}/questionnaires/${questionnaireId}`, function (questionnaire) {
                        console.log(questionnaire);
                        if (questionnaire && questionnaire.questions) {
                            console.log(questionnaire.questions);
                            const listQuestions = [];
                            const yesNoQuestions = [];
                            var index = 0;
                            questionnaire.questions.forEach(function (question, index) {
                                index += 1;
                                if (question.type.toLowerCase() === 'list') {
                                    console.log(index);
                                    console.log(question);
                                    listQuestions.push({ question, index });
                                } else if (question.type.toLowerCase() === 'yesno') {
                                    console.log(index);
                                    console.log(question);
                                    yesNoQuestions.push({ question, index });
                                }
                            });

                            if (listQuestions.length > 0) {
                                listQuestions.forEach(function (item) {
                                    const question = item.question;
                                    const index = item.index;
                                    console.log(question);
                                    console.log(results);
                                    generateListGraph(question, results, index); // Pasar el índice como tercer parámetro
                                });
                            }
                            if (yesNoQuestions.length > 0) {
                                yesNoQuestions.forEach(function (item) {
                                    const question = item.question;
                                    const index = item.index;
                                    console.log(question);
                                    console.log(results);
                                    generateYesNoGraph(question, results, index); // Pasar el índice como tercer parámetro
                                });
                            }
                        }
                    });
                }

            });
        }

        function generateListGraph(question, results, index) {
            // Conteo de respuestas para cada opción de la lista
            const optionCounts = {};
            question.answerOptions.forEach(function (option) {
                optionCounts[option] = 0;
            });

            // Contar respuestas en los resultados
            results.forEach(function (result) {
                console.log(result.answers[index]);
                if (optionCounts.hasOwnProperty(result.answers[index])) {
                    optionCounts[result.answers[index]]++;
                    console.log(optionCounts[result.answers[index]]);
                }
            });

            // Preparar datos para la gráfica
            const labels = Object.keys(optionCounts);
            const data = labels.map(option => optionCounts[option]);

            // Crear el canvas para la gráfica
            const chartCanvas = $('<canvas>').addClass('list-chart');
            $('#chartContainer').append($('<h3>').text(question.question)).append(chartCanvas);
            // Generar la gráfica
            const ctx = chartCanvas[0].getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Response Count',
                        data: data,
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Response Count'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Options'
                            }
                        }
                    }
                }
            });
        }

        function generateYesNoGraph(question, results, index) {
            const yesCount = results.filter(result => result.answers[index] === 'Yes').length;
            const noCount = results.filter(result => result.answers[index] === 'No').length;

            // Crear un nuevo elemento canvas para el gráfico yesno
            const chartCanvas = $('<canvas>').addClass('doughnut-chart');
            $('#chartContainer').append($('<h3>').text(question.question)).append(chartCanvas);

            // Obtener el contexto del canvas
            const ctx = chartCanvas[0].getContext('2d');

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Yes', 'No'],
                    datasets: [{
                        label: 'Yes/No',
                        data: [yesCount, noCount],
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.5)',
                            'rgba(255, 99, 132, 0.5)',
                        ],
                        borderColor: [
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 99, 132, 1)',
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true, // Hace que el gráfico se ajuste al contenedor
                    maintainAspectRatio: false, // Evita que el gráfico se estire para mantener la relación de aspecto
                }
            });
        }

        function createChart(susValues) {
            const ctx = document.getElementById('myChart').getContext('2d');
            const myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: susValues.length}, (_, i) => `Pregunta ${i+1}`),
                    datasets: [{
                        label: 'Number of Participants',
                        data: susValues,
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // Importante para mantener la relación de aspecto
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Participants'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'SUS Score'
                            }
                        }
                    }
                }
            });
        }


        function generateBoxPlots(results, questions) {
            Object.entries(questionResponses).forEach(([question, responses], index) => {
                const canvasId = 'boxPlot' + question;
                const canvasElement = `<canvas id="${canvasId}"></canvas>`;
                $('#chartContainer').append(canvasElement);
                const ctx = document.getElementById(canvasId).getContext('2d');
                new Chart(ctx, {
                    type: 'boxplot',
                    data: {
                        labels: [questions[index]],
                        datasets: [{
                            label: 'Answers to question ' + question,
                            data: [responses],
                            backgroundColor: 'rgba(255, 99, 132, 0.5)',
                            borderColor: 'rgba(255, 99, 132, 1)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            });
        }

        
    </script>

</body>

</html>
